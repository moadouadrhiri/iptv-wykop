---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import SEO from '../components/SEO.astro';
import FlashSaleBanner from '../components/FlashSaleBanner';
import HeroSection from '../components/HeroSection';
import TrustBadges from '../components/TrustBadges';
import FeatureGrid from '../components/FeatureGrid';
import FilmsSeriesSection from '../components/FilmsSeriesSection';
import SportsSection from '../components/SportsSection';
import PerformanceSection from '../components/PerformanceSection';
import GuaranteeSection from '../components/GuaranteeSection';
import HowToPurchaseSection from '../components/HowToPurchaseSection';
import CompatibleDevicesSection from '../components/CompatibleDevicesSection';
import PricingSection from '../components/PricingSection';
import FreeTrialCTA from '../components/FreeTrialCTA';
import TestimonialSection from '../components/TestimonialSection';
import FAQSection from '../components/FAQSection';
import CTASection from '../components/CTASection';
import StickyContactButton from '../components/StickyContactButton';
import MobileBottomCTA from '../components/MobileBottomCTA';
import SEOContentSection from '../components/SEOContentSection';
import {
  generateOrganizationSchema,
  generateProductSchema,
  generateWebSiteSchema,
  generateBreadcrumbSchema,
  generateFAQSchema,
  generateReviewSchema,
} from '../utils/schema';

const [serviceInfoEntries, siteConfigEntries, pricingPlans, faqItems, testimonials] = await Promise.all([
  getCollection('service-info'),
  getCollection('site-config').catch(() => []),
  getCollection('pricing'),
  getCollection('faq'),
  getCollection('testimonials').catch(() => []),
]);

const serviceInfo = serviceInfoEntries[0];
const data = serviceInfo?.data || {};
const siteConfig = siteConfigEntries[0]?.data || {};
const guaranteeDays = siteConfig.guaranteeDays || 30;
const channelCount = data.channelCount || 28000;
const vodCount = data.vodCount || 90000;
const countryCount = siteConfig.countryCount || 100;

const baseUrl = data.siteUrl || Astro.url.origin;

const contactInfo = data.contactInfo || {};
const whatsappNumber = contactInfo.whatsappNumber;
const telegramUsername = contactInfo.telegramUsername;

const organizationSchema = generateOrganizationSchema({
  name: data.brandName,
  url: baseUrl,
  logo: `${baseUrl}/favicon.svg`,
  description: data.description,
  email: data.supportEmail,
  phone: data.supportPhone,
  socialProfiles: Object.values(data.socialLinks || {}).filter(Boolean) as string[],
});

const productSchema = generateProductSchema({
  name: `${data.brandName} IPTV Subscription`,
  description: data.description,
  brand: data.brandName,
  offers: pricingPlans.map(plan => ({
    priceCurrency: plan.data.currency,
    price: plan.data.price,
    name: plan.data.name,
    url: `${baseUrl}/pricing`,
  })),
  aggregateRating: {
    ratingValue: 4.9,
    reviewCount: testimonials.length > 0 ? testimonials.length * 127 : 25567,
  },
});

const websiteSchema = generateWebSiteSchema(
  data.brandName,
  baseUrl,
  data.description
);

const breadcrumbSchema = generateBreadcrumbSchema([
  { name: 'Home', url: baseUrl },
]);

const sortedPricing = [...pricingPlans].sort((a, b) => (a.data.order || 0) - (b.data.order || 0));
const sortedFaq = [...faqItems].sort((a, b) => (a.data.order || 0) - (b.data.order || 0));

const faqSchema = sortedFaq.length > 0 
  ? generateFAQSchema(sortedFaq.map(f => ({
      question: f.data.question,
      answer: f.body || f.data.answer || '',
    })))
  : null;

const reviewSchema = testimonials.length > 0
  ? generateReviewSchema(
      testimonials.map(t => ({
        author: t.data.author || t.data.name || 'Customer',
        reviewBody: t.body || t.data.content || '',
        ratingValue: t.data.rating || 5,
        datePublished: t.data.date ? new Date(t.data.date) : undefined,
      })),
      { name: `${data.brandName} IPTV Service` }
    )
  : null;

const schemas = [
  organizationSchema, 
  productSchema, 
  websiteSchema, 
  breadcrumbSchema,
  faqSchema,
  reviewSchema,
].filter(Boolean);
---

<BaseLayout>
  <SEO
    slot="head"
    title={`${data.brandName} - Premium IPTV Service | ${channelCount.toLocaleString()}+ Channels`}
    description={data.description || `Experience premium IPTV with ${channelCount.toLocaleString()}+ live channels, ${vodCount.toLocaleString()}+ movies and series. HD & 4K quality, 24/7 support, ${guaranteeDays}-day money back guarantee.`}
    canonicalURL={baseUrl}
    ogImage={`${baseUrl}/og-image.jpg`}
    schema={schemas}
    pageType="home"
  />

  <!-- Flash Sale Banner (Sticky) -->
  <FlashSaleBanner
    client:load
    title="FLASH SALE!"
    offerText="Get 12 Months + 2 Months FREE!"
    ctaText="Claim Offer"
    ctaLink="#pricing"
    primaryColor={data.primaryColor}
  />

  <!-- Section 1: Hero with Dual CTAs -->
  <HeroSection
    client:load
    title={data.brandName}
    subtitle={data.tagline || `Access ${channelCount.toLocaleString()}+ live TV channels and ${vodCount.toLocaleString()}+ movies and series. Premium HD & 4K streaming with 99.9% uptime guarantee.`}
    channelCount={channelCount}
    vodCount={vodCount}
    primaryColor={data.primaryColor}
    showFreeTrial={true}
    whatsappNumber={whatsappNumber}
    trialHours={24}
  />

  <!-- Trust Badges -->
  <TrustBadges 
    client:visible 
    primaryColor={data.primaryColor} 
    variant="horizontal"
    guaranteeDays={guaranteeDays}
  />

  <!-- Features Grid -->
  {data.features && data.features.length > 0 && (
    <FeatureGrid client:visible features={data.features} primaryColor={data.primaryColor} />
  )}

  <!-- Section 2: Films & Series -->
  <FilmsSeriesSection 
    client:visible 
    brandName={data.brandName} 
    primaryColor={data.primaryColor} 
  />

  <!-- Section 3: Sports -->
  <SportsSection 
    client:visible 
    brandName={data.brandName} 
    primaryColor={data.primaryColor} 
  />

  <!-- Performance Section (No Buffering) -->
  <PerformanceSection
    client:visible
    brandName={data.brandName}
    primaryColor={data.primaryColor}
    uptimePercent={99.9}
    channelCount={channelCount}
    countryCount={countryCount}
  />

  <!-- Section 4: Money Back Guarantee -->
  <GuaranteeSection 
    client:visible 
    brandName={data.brandName} 
    primaryColor={data.primaryColor}
    guaranteeDays={guaranteeDays}
  />

  <!-- Section 5: How to Purchase -->
  <HowToPurchaseSection 
    client:visible 
    brandName={data.brandName} 
    primaryColor={data.primaryColor} 
  />

  <!-- Section 6: Compatible Devices -->
  <CompatibleDevicesSection 
    client:visible 
    brandName={data.brandName} 
    primaryColor={data.primaryColor} 
  />

  <!-- Pricing Section with Countdown -->
  <div id="pricing">
    {sortedPricing.length > 0 && (
      <PricingSection
        client:visible
        plans={sortedPricing.map(p => ({ ...p.data, slug: p.id }))}
        primaryColor={data.primaryColor}
        paymentSettings={data.paymentSettings}
        brandName={data.brandName}
      />
    )}
  </div>

  <!-- Free Trial CTA Section -->
  <FreeTrialCTA
    client:visible
    brandName={data.brandName}
    channelCount={channelCount}
    trialHours={24}
    primaryColor={data.primaryColor}
    whatsappNumber={whatsappNumber}
  />

  <!-- Testimonials with Stars and Locations -->
  {testimonials.length > 0 && (
    <TestimonialSection
      client:visible
      testimonials={testimonials.map(t => ({ 
        ...t.data, 
        content: t.body || t.data.content || '',
        verified: true,
      }))}
      primaryColor={data.primaryColor}
      showCTA={true}
      ctaLink="#pricing"
    />
  )}

  <!-- FAQ Section -->
  {sortedFaq.length > 0 && (
    <FAQSection 
      client:visible 
      items={sortedFaq.map(f => ({ question: f.data.question, answer: f.body || '' }))} 
    />
  )}

  <!-- SEO Content Section (Expandable) -->
  <SEOContentSection
    client:visible
    brandName={data.brandName || 'IPTV Service'}
    channelCount={channelCount}
    countryCount={countryCount}
    vodCount={vodCount}
    primaryColor={data.primaryColor}
  />

  <!-- Final CTA Section -->
  <CTASection
    client:visible
    title="Ready to Start Streaming?"
    subtitle={`Join thousands of satisfied customers and experience premium entertainment with ${channelCount.toLocaleString()}+ channels`}
    buttonText="Get Started Now"
    buttonLink="#pricing"
    primaryColor={data.primaryColor}
  />

  <!-- Sticky Contact Button (Mobile) -->
  <StickyContactButton
    client:load
    whatsappNumber={whatsappNumber}
    telegramUsername={telegramUsername}
    brandName={data.brandName}
    primaryColor={data.primaryColor}
  />

  <!-- Mobile Bottom CTA Bar -->
  <MobileBottomCTA
    client:load
    pricingLink="#pricing"
    trialLink={whatsappNumber ? `https://wa.me/${whatsappNumber}` : '/free-trial'}
    primaryColor={data.primaryColor}
    showTrial={true}
  />
</BaseLayout>
